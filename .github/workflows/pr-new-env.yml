name: PR New Environment

on:
  pull_request_target:
    types:
      - opened
      - reopened
      - synchronize
    paths:
      - 'src/envs/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  detect-new-envs:
    name: Detect Newly Added Environments
    runs-on: ubuntu-latest
    outputs:
      has_new_envs: ${{ steps.detect.outputs.has_new_envs }}
      new_envs: ${{ steps.detect.outputs.new_envs }}
      new_envs_json: ${{ steps.detect.outputs.new_envs_json }}
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          path: base
          fetch-depth: 0
          persist-credentials: false

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          path: pr
          fetch-depth: 0
          persist-credentials: false

      - name: Determine new environment directories
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -d base/src/envs ]; then
            echo "Base repository missing src/envs directory."
            echo "has_new_envs=false" >> "$GITHUB_OUTPUT"
            echo "new_envs=" >> "$GITHUB_OUTPUT"
            echo "new_envs_json=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ ! -d pr/src/envs ]; then
            echo "PR repository missing src/envs directory."
            echo "has_new_envs=false" >> "$GITHUB_OUTPUT"
            echo "new_envs=" >> "$GITHUB_OUTPUT"
            echo "new_envs_json=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          mapfile -t BASE_ENVS < <(cd base/src/envs && find . -maxdepth 1 -mindepth 1 -type d | sed 's|^\./||' | sort)
          mapfile -t PR_ENVS < <(cd pr/src/envs && find . -maxdepth 1 -mindepth 1 -type d | sed 's|^\./||' | sort)

          declare -A BASE_SET=()
          for env in "${BASE_ENVS[@]}"; do
            BASE_SET["$env"]=1
          done

          NEW_ENV_ARRAY=()
          for env in "${PR_ENVS[@]}"; do
            if [ -z "${BASE_SET[$env]:-}" ]; then
              NEW_ENV_ARRAY+=("$env")
            fi
          done

          if [ ${#NEW_ENV_ARRAY[@]} -eq 0 ]; then
            echo "No new environment directories detected."
            echo "has_new_envs=false" >> "$GITHUB_OUTPUT"
            echo "new_envs=" >> "$GITHUB_OUTPUT"
            echo "new_envs_json=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          printf 'Detected new environments: %s\n' "$(printf '%s ' "${NEW_ENV_ARRAY[@]}")"

          NEW_ENVS_COMMA=$(printf '%s\n' "${NEW_ENV_ARRAY[@]}" | paste -sd, -)
          NEW_ENVS_JSON=$(printf '%s\n' "${NEW_ENV_ARRAY[@]}" | python -c 'import json,sys; print(json.dumps([line.strip() for line in sys.stdin if line.strip()]))')

          echo "has_new_envs=true" >> "$GITHUB_OUTPUT"
          echo "new_envs=${NEW_ENVS_COMMA}" >> "$GITHUB_OUTPUT"
          echo "new_envs_json=${NEW_ENVS_JSON}" >> "$GITHUB_OUTPUT"

  deploy-and-health-check:
    name: Deploy and Validate New Environments
    needs: detect-new-envs
    if: needs.detect-new-envs.outputs.has_new_envs == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: ${{ fromJSON(needs.detect-new-envs.outputs.new_envs_json) }}
    env:
      HF_TOKEN: ${{ secrets.HF_PR_TOKEN }}
      HF_PR_TOKEN: ${{ secrets.HF_PR_TOKEN }}
      HF_NAMESPACE: ${{ vars.HF_PR_NAMESPACE }}
      SPACE_SUFFIX: -pr-${{ github.event.number }}
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          persist-credentials: false

      - name: Default Hugging Face namespace
        if: env.HF_NAMESPACE == ''
        shell: bash
        run: echo "HF_NAMESPACE=openenv-testing" >> "$GITHUB_ENV"

      - name: Verify Hugging Face token
        shell: bash
        run: |
          if [ -z "${HF_TOKEN:-}" ]; then
            echo "HF_TOKEN secret is required for deployment." >&2
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install OpenEnv package
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install .

      - name: Deploy environment with OpenEnv CLI
        shell: bash
        run: |
          set -euo pipefail
          repo_id="${HF_NAMESPACE}/${{ matrix.environment }}${SPACE_SUFFIX}"
          env_dir="src/envs/${{ matrix.environment }}"

          if [ ! -d "$env_dir" ]; then
            echo "Environment directory not found: $env_dir" >&2
            exit 1
          fi

          openenv push --directory "$env_dir" --repo-id "$repo_id"

      - name: Wait for deployment to stabilize
        shell: bash
        run: sleep 180

      - name: Compute Space URLs
        id: urls
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${HF_NAMESPACE:-}" ]; then
            echo "HF_NAMESPACE is not configured; unable to compute space URLs." >&2
            exit 1
          fi

          namespace_slug=$(echo "${HF_NAMESPACE}" | tr '[:upper:]' '[:lower:]' | tr '_' '-')
          space_name="${{ matrix.environment }}${SPACE_SUFFIX}"
          space_slug=$(echo "${space_name}" | tr '[:upper:]' '[:lower:]' | tr '_' '-')
          health_url="https://${namespace_slug}-${space_slug}.hf.space/health"
          live_url="https://${namespace_slug}-${space_slug}.hf.space"
          space_repo_url="https://huggingface.co/spaces/${HF_NAMESPACE}/${space_name}"
          space_repo_id="${HF_NAMESPACE}/${space_name}"

          echo "namespace_slug=${namespace_slug}" >> "$GITHUB_OUTPUT"
          echo "space_name=${space_name}" >> "$GITHUB_OUTPUT"
          echo "space_slug=${space_slug}" >> "$GITHUB_OUTPUT"
          echo "health_url=${health_url}" >> "$GITHUB_OUTPUT"
          echo "live_url=${live_url}" >> "$GITHUB_OUTPUT"
          echo "space_repo_url=${space_repo_url}" >> "$GITHUB_OUTPUT"
          echo "space_repo_id=${space_repo_id}" >> "$GITHUB_OUTPUT"

      - name: Perform environment health check
        id: health_check
        continue-on-error: true
        shell: bash
        env:
          HEALTH_URL: ${{ steps.urls.outputs.health_url }}
          SPACE_NAME: ${{ steps.urls.outputs.space_name }}
        run: |
          set -euo pipefail

          if [ -z "${HEALTH_URL:-}" ]; then
            echo "HEALTH_URL not provided; cannot perform health check." >&2
            exit 1
          fi

          echo "Checking health for ${SPACE_NAME} at ${HEALTH_URL}"

          success=0
          for attempt in {1..5}; do
            status=$(curl -sS -o response.json -w "%{http_code}" "$HEALTH_URL" || echo "000")
            if [ "$status" = "200" ]; then
              echo "Health check passed for ${SPACE_NAME}"
              cat response.json
              success=1
              break
            fi
            echo "Attempt ${attempt} returned status ${status}. Retrying in 30 seconds..."
            sleep 30
          done

          if [ $success -ne 1 ]; then
            echo "Health check failed for ${SPACE_NAME}" >&2
            if [ -f response.json ]; then
              echo "Last response payload:"
              cat response.json
            fi
            exit 1
          fi

      - name: Comment on PR with deployment status
        if: always()
        uses: actions/github-script@v7
        env:
          HEALTH_CONCLUSION: ${{ steps.health_check.conclusion }}
          SPACE_NAME: ${{ steps.urls.outputs.space_name }}
          LIVE_URL: ${{ steps.urls.outputs.live_url }}
          SPACE_REPO_URL: ${{ steps.urls.outputs.space_repo_url }}
          SPACE_REPO_ID: ${{ steps.urls.outputs.space_repo_id }}
          ENV_NAME: ${{ matrix.environment }}
          COMMENT_TAG: "<!-- openenv-pr-preview -->"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const status = process.env.HEALTH_CONCLUSION || 'failure';
            const envName = process.env.ENV_NAME;
            const marker = process.env.COMMENT_TAG;

            const header = status === 'success'
              ? `✅ Deployment to Hugging Face succeeded for \`${envName}\``
              : `⚠️ Deployment Hugging Face failed for \`${envName}\``;

            const summary = status === 'success'
              ? 'Nice work! Wait for a code review and we\'re ready to go. You can test it with the CLI:'
              : 'Please resolve your environment and test it with the CLI:';

            const envDir = 'src/envs/' + envName;

            const bodyLines = [
              marker,
              '',
              header,
              '',
              '',
              summary,
              '',
              '- `openenv push --directory ' + envDir + ' --repo-id <your-username>/' + envName + '`',
            ];

            const {owner, repo} = context.repo;
            const issue_number = context.payload.pull_request.number;
            const serverUrl = process.env.GITHUB_SERVER_URL || 'https://github.com';
            const runUrl = `${serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`;

            if (status !== 'success') {
              bodyLines.push(`- Failed run: ${runUrl}`);
            } else {
              bodyLines.push(`- Success run: ${runUrl}`);
            }

            const bodyText = bodyLines.join('\n');

            const existing = await github.paginate(
              github.rest.issues.listComments,
              { owner, repo, issue_number, per_page: 100 },
              (response, done) => {
                const match = response.data.find(comment => comment.body && comment.body.includes(marker));
                if (match) {
                  done();
                  return [match];
                }
                return [];
              }
            );

            if (existing.length > 0) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing[0].id,
                body: bodyText,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: bodyText,
              });
            }

      - name: Delete preview space on Hugging Face
        if: always()
        continue-on-error: true
        shell: bash
        env:
          SPACE_REPO_ID: ${{ steps.urls.outputs.space_repo_id }}
        run: |
          set -euo pipefail
          if [ -z "${SPACE_REPO_ID:-}" ]; then
            echo "No space repo id; skipping deletion"
            exit 0
          fi

          TOKEN="${HF_TOKEN:-${HF_PR_TOKEN:-}}"
          if [ -z "$TOKEN" ]; then
            echo "HF token not available; cannot delete space"
            exit 0
          fi

          set +e
          hf repo delete "$SPACE_REPO_ID" --repo-type space --yes --token "$TOKEN"
          status=$?
          set -e

          if [ $status -eq 0 ]; then
            echo "Deleted preview space $SPACE_REPO_ID"
          else
            echo "Failed to delete space $SPACE_REPO_ID (exit $status)"
          fi

      - name: Fail job if health check failed
        if: steps.health_check.conclusion == 'failure'
        run: exit 1
